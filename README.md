# VK-friends-report
*Это консольное приложение, позволяющее получить список подписчиков (друзей) для переданного ID пользователя VK и генерирующее отчет в форматах CSV, TSV или JSON.*
 ***
 
**Версия Python:** 3.9
 
**Среда, в которой написана программа:** Windows 10
 
**Модули, используемые для работы:** os, sys, datetime.datetime, csv, json, requests
 
**Модули, используемые для тестирования:** unittest и unittest.TestCase
 
**Модули, требующие дополнительной установки:** requests 
 
>*Для установки можно использовать меденжер пакетов pip. Подробнее можно прочитать тут: https://pypi.org/project/requests/*
 
***
## Подготовка к использованию программы
*Для начала работы с парсером данных, пользователю требуется сгенерировать токен и ID человека, чей список друзей нужно получить.* 
  
 ### Получение токена:
  
 Для взаимодествия с Вконтакте используется их открытый API VK *(Подробнее тут: https://dev.vk.com/guide )*.
  
 Чтобы пользоваться API VK требуется токен, благодаря которому сервер идентифицирует от чьего имени поступает запрос.
  
 **Получение токена можно разделить на две части:**
  - регистрация своего приложения;
  - получение токена в этом приложении.
  
 Создать приложение можно на этой странице: https://vk.com/editapp?act=create
  
 *Создавать приложение лучше на платформе **Standalone**. Это позволит получить наибольшие возможности, чем в иных вариантах выбора.*
  
 Создав приложение и перейдя на вкладку настроек, нужно скопировать **ID приложения** и подставить в эту ссылку:
  
 >https://oauth.vk.com/authorize?client_id={ID_Приложения}&display=page&redirect_uri=https://oauth.vk.com/blank.html&scope=friends,offline&response_type=token&v=5.131
  
В scope перечисляются разрешения для приложения (подробный список разрешений: https://vk.com/dev/permissions ). Нам нужно только friends и offline (*offline позволяет создать бессрочный токен*). Также можно указать более актуальную версию API (например: v=5.131).
  
Перейдя по сформированной ссылке, откроется диалоговое окно, в котором будут показаны разрешения для вашего токена (нужно будет принять, если все устраивает). После чего произойдёт переадресация на страницу, в адресной строке которой будет **access_token**. С помощью данного токена можно выполнять запросы к API VK. **Сохрани его.**
  
### Получение ID пользователя:
  
Для получения ID пользователя достаточно перейти на его профиль VK, открыть любую фотографию и в адресной строке первые цифры после **photo** и до **нижнего подчеркивания** будут являться идентификатором пользователя. Или можно воспользоваться любым сторонним сервисом, скопировав туда url главной странички пользователя.

***
## Взаимодействие с программой

>**Для начала работы с приложением требуется запусть файл START.py**.
>
>*Для завершения работы с программой достаточно ввести в любой момент вместо ввода данных **"Q"** (или **"q"**).*
  
### Что подается на вход:
  
  - Токен (access_token), позволяющий от вашего лица выполнять запросы к API VK.
  - Идентификатор пользователя (ID), для которого будет формироваться запрос к серверу на получение списка друзей.
  - Формат выходного файла CSV, TSV или JSON (*по умолчанию CSV*).
  - Путь для сохранения отчета (*по умолчанию в корне с программой создаcтся папака REPORTS*)

### Что будет на выходе:
  
- После удачного ввода Токена и ID пользователя в консоль выведется статус соединения.
- Если соединение с API VK было установлено удачно, выведется общее количество аккаунтов для предоставленного ID.
>*Если по какой-то причине для ID количество пользователей оказалось равным 0, то программа предложит либо завершить работу, либо начать вводить данные с самого начала.*
- После выбора формата отчета, в консоль выведется выбранный формат конечного файла.
- После выбора пути сохранения отчета, выбранный путь выведется на экран.
- В конце программа сообщит о запуске извелечения данных и будет выводить в консоль количество сохраненных пользователей.
- После извлечения данных, в консоль выведется: количество удачно извлеченных пользователей и количество деактивированных аккаунтов, которые не содержат полезной информации, а так же наименование отчета (report.*формат*).
- Результатом работы станет отчет в соответствующем формате с определенной структурой (указаны заголовки для CSV, TSV и ключи для JSON):
```diff
* Имя пользователя (first_name)
* Фамилия пользователя (last_name)
* Страна (country)
* Город (city)
* День рождения в ISO формате (bdate) - YYYY.MM.DD или MM.DD
* Пол (sex)
```

### Правила ввода данных (ошибки и исключения):

- Токен должен быть комбинацией символов ASCII и цифр, не содержать различных знаков препинания и слэшей, не содержать пробелов.
- Идетификатор пользователя должен быть кобинацией чисел без знаков препинания, слешей и пробелов.

*Если ввести неверный токен или ID, то внутри класса VkApiGet выбросится исключение ValueError, недопускающее дальнейшую работу с API VK. Пользователь будет оповещен о том, что введенные данные не соотвествуют требованиям.*

- В процессе работы программы должно быть установлено соединение с API VK.

*Если соединение по какой-то причине установить не удастся, внетри VkApiGet выбросится исключение ConnectionError, пользователь получит соответствующее сообщение и программа автоматически завершит работу.*

- Токен должен обладать определенными правами и должен быть реальным и действительным, также как и ID пользователя.

*Если токен или ID будут неверными, север в ответ выдаст ответ с ошибками и внутри VkApiGet выборсится исключение ConnectionError, пользователь получит соответствующее сообщение и программа автоматически завершит работу.*

- В ответе сервера для переданного ID пользователя должен быть хотя бы один друг (подписчик).

*Если у пользователя не будет друзей, программа не даст работать дальше с данным ID, выведет соотвествующее сообщение и предложит либо начать работу с приложением сначала, либо завершить работу. Также, теоретически возможно, что при парсинге данных с 0 пользователей произойдет выборс исключения EmptyValueError внутри класса FileSaver, хотя программа не должна дать возможности дойти до этого этапа.*

- При вводе пути для сохранения отчета нужно указывать существующий путь (за исключением конечной папки, ее программа может сгенерировать). Нельзя в названии папки использовать недопустимые символы "/\:?«<>|". Так же лучше воздержаться от использования "\" в пути, т.к. python может принять данный символ за экранированную последовательностб (escape sequence).

*В случае неудачного ввода программа выбрасывает исключения (SyntaxError, FileNotFoundError, OSError) внутри класса FileSaver. Пользователь получает соотвествующее уведомление и еще одну попытку ввода пути для сохранения данных.*


### Дополнительные переменные:

- Можно изменить количество пользователей, получаемых в одном запросе в API VK.
>Внутри файла work_with_user.py изменить переменную user_per_page на любое другое целое положительное число.

- Можно добавить дополнительные поля в запрос (например ID пользователя), тогда они появятся в отчете.
>Внутри файла work_with_user.py внестиизменения в list с именем param. Для корректной работы нужно использовать такие поля (параметры), которые которые представлены в API VK для метода friends.get.

- Можно изменить конечное имя отчета.
>Внутри файла generate_report.py в классе FileSaver изменить переменную file_name на любое другое строчное допустимое (для имени файла) значение.

- Можно изменить версию API VK.
>Внутри файла work_with_api.py в классе VkApiGet изменить переменную api_version на соотвествующую версию API VK. Внимение: она должна быть str, а при проверке float!

***
## Как устроена программа

Запуск прогрограммы производится из файла **START.py**, в который импортирвоан метод **run_program()** модуля **work_with_user.py**. В методе **run_program()** реализовано взаимодействие функций и модулей, позволяющих собрать всю необходимую информацию у пользователя для корректной работы приложения.

В первую очередь после получения токена и ID пользователя создается экземпляр класса **VkApiGet** в функции **run_vk_api()**. Внутри него проверяется корректность ввода данных от пользователя и наличие соединения с API VK, а так же правильность получения ответа от сервера. Если все хорошо, **VkApiGet** формирует первый запрос к серверу, получая количество друзей для указанного ID.

Далее, если у ID есть хотябы один аккаунт (подписчик) в ответе, программа запрашивает у пользователя один из предложенных форматов сохранения извлеченных данных с помощью функции **input_format()**.

На следующем этапе, программа запрашивает у пользователя путь для сохранения данных с помощью функции **input_path()**. Внутри нее сформируется экземпляр класса **FileSaver**, который проверит вводимые пользователем данные и сгенерирует возможный путь и новые директории для сохранения отчета.

В конце запускается метод **run()** класса **FileSaver** внутри которого генерируется экземпляр класса ItemConstructor для извлчения данных, полученных внутри ответа от API VK с помощью ранее сформированного экземпляра **VkApiGet**. Если пользователей в ответе слишком много, то будут запрашиваться у сервера частями и каждый раз дозаписываться в файл. Пользователь будет видеть в консоли процесс извелечения данных. После того, как все данные будут получены, программа "попрощается" и завершит свою работу.



***
## Unit-тестирование

*К сожалению, я еще не освоил тестирвоание в полной мере, поэтому код покрыт тестами далеко не полностью.*

### Тест класса ItemConstructor (test_item_parser.py):

**Входные данные**:
- param - основные параметры (или поля), по которым формируется готовый массив данных;
- dates - массив дат, включающий типовые даты в ответе с сервера и такие же даты, но в ISO формате;
- sourse_users - массив с пользователями, полученными из ответа сервера;
- final_users - массив с пользователями, который должен получиться в результате работы методов класса.

**Тесты**:
- test_date_to_iso - тест, проверяющий только работу преобразование дат в ISO формат;
- test_get_one_item - тест, проверяющий работу основного парсера по переданным параметрам (берет по одному пользователю за итерацию);
- test_get_items - тест, проверяющий работу метода обхода массива данных и способность отсекать деактивированные аккаунты.
- test_counter - тест, проверяющщий работу счетчиков извлеченных и отсеченных пользователей.


### Тест класса FileSaver (test_generate_report):

**Входные данные**:
- file_format - формат файла;
- param - основные параметры (или поля), по которым формируется запрос к API VK;
- this_dir - текущая директория;
- дполнительные генерируемые директории для теста.

**Тесты**:
- test_generate_filepath - тест, проверяющий работу генератора директории и способность выбрасывать ошибки в случае получения некорректного адреса для сохранения отчета.
- test_filename_join - тест, проверяющий правильность получения конечного адреса файла.
